# HTTP 쿠키

HTTP 프로토콜은 기본적으로 `Stateless`한 속성을 가지고 있습니다. 클라이언트와 서버가 요청과 응답을 주고 받으면 연결이 끊어지고, 서버는 이전 요청을 기억하지 못하게 됩니다.

예컨대, 로그인 상태 또한 기억하지 못하기 때문에 모든 요청에 사용자 정보를 포함해야하는 문제가 있습니다. 이런 문제를 해결하기 위해 `쿠키`라는 개념이 도입된 것입니다.

<br/>

## 1. HTTP 쿠키란?

`HTTP 쿠키`(HTTP Cookie)는 서버가 클라이언트에 전송하는 작은 데이터 조각으로, `key=value` 형식의 문자열 데이터 묶음입니다. 브라우저는 쿠키를 저장해두었다가 동일한 서버에 재요청 시 쿠키 데이터를 전송할 수 있습니다. 이로써 무상태 환경에서 클라이언트를 식별하고, 상태를 유지하는 개념을 가능하게 합니다.

<br/>
<br/>

## 2. HTTP 쿠키의 용도

쿠키는 일반적으로 세 가지 목적으로 사용됩니다.

1. 트래킹(`Tracking`): 특정 브라우저에서 사용자의 브라우징 활동을 기록하여 분석 데이터를 수집하거나 광고 개제를 위해 사용됩니다.
2. 인증(`Authentication`): 현재 서버에 로그인한 사용자의 정보를 저장하여 HTTP 요청이 발생할 때마다 다시 인증하지 않도록 합니다.
3. 개인화(`Preferences`): 테마처럼 웹 사이트에 대한 사용자 지정 설정은 HTTP 세션 간에 유지되어 사용자 경험을 개선할 수 있습니다.

<br/>
<br/>

## 3. HTTP 쿠키 헤더

![cookie](https://github.com/cona-tus/TIL/assets/90844424/492e0699-2daa-4924-8887-a70dea12720c)

쿠키를 사용할 땐 두 개의 헤더를 사용합니다.

### 1. Set-Cookie

서버에서 클라이언트로 전달하는 쿠키 헤더입니다. 서버가 HTTP 요청을 받으면, 브라우저에 데이터를 저장하도록 지시하기 위해 `Set-Cookie` 응답 헤더를 반환하여 쿠키를 전달할 수 있습니다.

```http
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length:
Set-Cookie: items=16
Set-Cookie: headercolor=blue
Set-Cookie: footercolor=green
Set-Cookie: screenmode=dark, Expires=Sun, 1 Jan 2023 12:00:00 GMT
Set-Cookie: job=111; Max-Age: 3600; Secure; HttpOnly
```

<br/>

### 2. Cookie

클라이언트가 서버에서 받은 쿠키를 저장하고, 이후 HTTP 요청 시 클라이언트에서 서버로 전달하는 쿠키 헤더입니다. 서버의 세션 상태 혹은 각종 클라이언트 정보를 담고 있습니다.

```http
GET / HTTP/1.1
Host: www.example.re
Cookie: items=16; headercolor=blue; screenmode=dark; job=111
```

<br/>
<br/>

## 4. 쿠키의 문제점

쿠키 사용에 있어서 한계점은, 쿠키 정보는 모든 HTTP 요청과 함께 서버에 전송된다는 것입니다. 이는 중복된 데이터가 반복해서 전송되어 불필요한 네트워크 트래픽이 추가로 소비될 수 있습니다. 또한 정보가 클라이언트 측에서 관리되기 때문에 악용될 우려가 있고, 보안에 취약하여 정보를 탈취 당할 위험성이 존재합니다. 따라서 쿠키는 세션 id나 인증 토큰 등 최소한의 정보만 사용해야합니다.

만약 서버에 전송하지 않고 웹 브라우저 내부에 데이터를 저장하고 싶다면 웹 스토리지(localStorage, sessionStorage)를 사용할 수 있습니다만, 보안에 민감한 데이터는 주의해야 합니다.

<br/>
<br/>

## 5. 쿠키의 지속성과 생명 주기

쿠키는 일반적으로 지속성이 있으며, 서버에서 생명주기를 지정하여 만료일을 설정할 수 있습니다. 참고로, 만료 날짜는 서버가 아닌 클라이언트 브라우저에 의해 관리됩니다.

### 1. 영속 쿠키

```http
Set-Cookie: expires=Sat, 26-Dec-2020 04:39:21 GMT
```

서버는 응답에 `expires` 속성을 포함하여 만료일까지만 쿠키가 유지되도록 할 수 있습니다.
영구적인 쿠키는 상당한 시간 동안 사용 가능할 수 있지만, 브라우저는 시스템에서 쿠키를 지우는 기능을 제공하기도 합니다.

<br/>

### 2. 세션 쿠키

```http
Set-Cookie: max-age=3600 (3600초)
```

서버가 시간 제한을 설정하여 일정 시간 후 쿠키를 삭제하게 할 수 있습니다. 이 값은 쿠키가 만료될 때까지의 초 수이며, 만료 날짜를 생략하면 브라우저 종료 시까지만 유지됩니다. 0이나 음수를 지정하면 해당 쿠키가 삭제됩니다.

<br/>
<br/>

## 6. 도메인 제한

쿠키는 브라우저 또는 특정 사이트 별로 저장되므로, 도메인을 지정하여 쿠키에 접근할 수 있습니다.

도메인을 생략하면 현재 문서 기준 도메인만을 적용하며, 하위 도메인은 제외됩니다. 예를 들어, 쿠키를 보낸 서버가 `example.org`이라면 도메인 헤더 필드를 생략하면 `dev.example.org`와 같은 하위 도메인으로 보내지 않을 것입니다.

도메인을 명시하면, 명시한 문서 기준 도메인과 서브 도메인을 포함해 쿠키 사용 접근이 가능합니다. 필드 값을 `Domain=example.org`로 설정하면 example.org는 물론이고, `dev.example.org`과 같은 하위 도메인에서도 접근할 수 있습니다. 이처럼 도메인을 지정함으로써 더 넓은 액세스 권한을 부여할 수 있습니다.

<br/>
<br/>

## 7. 경로 제한

도메인 속성이 쿠키의 범위를 확장하는 데 사용되는 방식과 유사하게, `path` 속성은 그것을 더욱 제한하는 데 사용될 수 있습니다.

쿠키에 경로를 설정하면, 해당 페이지 경로에서만 쿠키 사용 접근이 가능합니다. 다시 말해, 지정된 경로를 포함해 하위 경로 페이지만 쿠키가 전송됩니다. 일반적으로 루트 경로 (`path=/`)로 지정하는데, 한 도메인 안에서 모든 경로에 쿠키가 유효하길 바라기 때문입니다.

<br/>

e.g. `path=/news/` 속성이 포함된 경우, /news 경로에 쿠키를 적재하게 됩니다.

| Path                | Match                                     |
| ------------------- | ----------------------------------------- |
| /news or /news/     | Yes – Exact match                         |
| /news/current       | Yes – Valid subdirectory                  |
| /news/current/world | Yes – Valid subdirectory                  |
| /                   | No – The root directory is not accessible |
| /oldnews            | No – Different subdirectory               |

상위 수준의 `news` 경로 및 그 아래의 모든 디렉토리에 액세스할 수 있습니다. 경로에 존재하지 않으면 쿠키가 전송되지 않습니다.

<br/>
<br/>

## 8. 보안 및 접근 제한

쿠키는 인증 정보를 유지할 수 있는 기능이 있기 때문에 보안을 위해 접근을 제어하는 것이 필요할 수 있습니다. 이를 위해 사용할 수 있는 속성, Secure, HttpOnly, SameSite에 대해 알아봅시다.

```http
Set-Cookie: jobid=111; Expires=Sun, 1 Jan 2023 12:00:00 GMT; Secure; HttpOnly
```

<br/>

### 1. Secure

쿠키는 기본적으로 HTTP와 HTTPS를 구분하지 않고 전송됩니다. `Secure` 속성을 적용하면 쿠키는 `HTTPS`인 경우에만 전송됩니다.

<br/>

### 2. HttpOnly

`HttpOnly` 속성은 자바스크립트에서 쿠키 사용 접근을 제한합니다. 이로써 `XSS` 공격\* 을 방지할 수 있습니다.

> \*크로스 사이트 스크립팅(Cross Site Scripting, XSS)
> 공격자가 상대방의 브라우저에 스크립트가 실행되도록 해 사용자의 세션을 가로채거나, 웹사이트를 변조하거나, 악의적 콘텐츠를 삽입하거나, 피싱 공격을 진행하는 것을 말한다.

<br/>

### 3. SameSite

도메인이 해당 리소스를 호스팅하는 서버와 일치하는 경우를 `퍼스트 파티 쿠키`(First-party cokkies)라고 합니다. 반대로 도메인이 다른 경우, 이를 `서드 파티 쿠키`(Third-party cokkies)라고 합니다. 서드 파티 쿠키는 주로 웹 사용 추적과 광고 목적으로 사용되며, 예시로는 웹 페이지의 광고 배너가 있습니다. 이들은 하나의 도메인에 표시되지만 다른 곳에서 호스팅됩니다.

서버는 `SameSite` 속성을 사용하여 클라이언트에게 쿠키를 서드 파티 사이트로 보낼지 여부를 알릴 수 있습니다. 이는 XSRF(CSRF) 공격\* 공격에 대한 보호를 제공하기 위한 것으로, 요청 도메인과 쿠키에 설정된 도메인이 같은 경우에만 쿠키를 전송하게 됩니다.

> \*CSRF(Cross-Site Request Forgery)
> 사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위(수정, 삭제, 등록 등)를 특정 웹사이트에 요청하게 하는 공격을 말한다. 사용자가 의도하지 않았지만, 자신도 모르게 서버를 공격하게 되는 경우이다.

<br/>
<br/>

#### 참고

- [모든 개발자를 위한 HTTP 웹 기본 지식](https://inf.run/YWJd '김영한')
- [🌐 웹 브라우저의 Cookie 헤더 다루기](https://inpa.tistory.com/entry/HTTP-%F0%9F%8C%90-%EC%9B%B9-%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80%EC%9D%98-%EC%BF%A0%ED%82%A4-%EA%B0%9C%EB%85%90-Cookie-%ED%97%A4%EB%8D%94-%EB%8B%A4%EB%A3%A8%EA%B8%B0 '인파')
- [HTTP Cookies](https://http.dev/cookies 'http.dev')
